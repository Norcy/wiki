è½¬è‡ªå…¬å¸å†…å¤§ä½¬çš„æ–‡ç« ï¼Œæ·±å…¥æµ…å‡ºçš„å†™æ³•å€¼å¾—å­¦ä¹ 

## TLDR

æºç å®ç°

```ts
/** å¯åœ¨åŒä¸€å‡½æ•°é‡å¤å¤šæ¬¡ä½¿ç”¨ï¼Œäº’ä¸å¹²æ‰° */
export function useSingleton<T>(callBack: () => T): T {
    const [T] = useState(callBack);
    return T
}
```

ä½¿ç”¨ä¾‹å­

```ts
function Example() {
  // ä¸å¸¦è¿”å›å€¼ï¼Œåªä¼šè§¦å‘ä¸€æ¬¡ï¼Œç›¸æ¯” useEffectï¼Œè¯¥å‡½æ•°ä¼šåœ¨ render ä¹‹å‰è§¦å‘
  useSingleton(() => {
    console.log('init before render once');
  });

  // å¸¦è¿”å›å€¼
  const store:IStore = useSingleton(()=>{
    return new FileStore();
  });

  const [count, setCount] = useState(store.get('click_count'));

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>
       Click me
      </button>
    </div>
  );
}
```


## è¯¦ç»†è¯´æ˜
å‡½æ•°ç»„ä»¶æ˜¯ React æ¨å‡ºçš„æ–°çš„ç»„ä»¶å½¢å¼ï¼Œè®©å†™ç»„ä»¶å˜å¾—ç®€å•äº›ï¼Œå®ƒæŠ›å¼ƒäº†å¤æ‚çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼Œä¸“æ³¨äºå±•ç¤ºå’Œæ•°æ®ç›‘å¬ã€‚ä¸‹é¢è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š

```ts
import React, { useState } from 'react';

function Example() {
  const [count, setCount] = useState(0);

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>
       Click me
      </button>
    </div>
  );
}
```

å‡½æ•°ç»„ä»¶è¿”å›ä¸€ä¸ªæ ·å¼ï¼Œreact ä¼šåœ¨æ¯æ¬¡æ•°æ®å˜åŒ–çš„æ—¶å€™å°±è°ƒç”¨ä¸€æ¬¡æ­¤æ–¹æ³•è·å–æœ€æ–°æ ·å¼ã€‚
å¤§éƒ¨åˆ†æƒ…å†µï¼Œå‡½æ•°ç»„ä»¶éƒ½èƒ½æ»¡è¶³éœ€æ±‚ã€‚ä½†æœ‰ä¸€ä¸ªä¸šåŠ¡åœºæ™¯å‡½æ•°ç»„ä»¶ä¸æ”¯æŒï¼Œå°±æ˜¯æ„é€ å‡½æ•°ã€‚å‡½æ•°ç»„ä»¶å®é™…æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè‡ªç„¶è‚¯å®šæ²¡æœ‰ class  çš„æ„é€ å‡½æ•°ã€‚é‚£å¯¹ä¸€äº›ä¸€æ¬¡æ€§çš„åˆå§‹åŒ–é€»è¾‘è¯¥å¦‚ä½•å®ç°å‘¢ï¼ŸReact çš„[å®˜æ–¹è§£é‡Š](https://zh-hans.reactjs.org/docs/hooks-faq.html)æ˜¯å‡½æ•°ç»„ä»¶ä¸éœ€è¦æ„é€ å‡½æ•°ï¼Œå› ä¸ºçŠ¶æ€åˆå§‹åŒ–å¯ä»¥ç”¨ useStateã€‚

å®˜æ–¹è§£é‡Šå¯¹ä¸å¯¹æ˜¯å€¼å¾—å•†æ¦·çš„ï¼Œå› ä¸ºåˆå§‹åŒ–é˜¶æ®µä¸åªæ˜¯çŠ¶æ€åˆå§‹åŒ–ï¼Œä¹Ÿä¼šåŒ…å«ä¸€äº›ä¸šåŠ¡é€»è¾‘ã€‚é‚£æ—¢ç„¶å®˜æ–¹ä¸å‡†å¤‡æ”¯æŒï¼Œé‚£æˆ‘ä»¬æœ‰ä»€ä¹ˆåŠæ³•æ¨¡æ‹Ÿå‘¢ï¼Ÿ
é¦–å…ˆæˆ‘ä»¬èƒ½æƒ³åˆ°çš„æ˜¯ useEffect æ–¹æ³•ã€‚useEffect ä¼šåœ¨ render ç»“æŸåè°ƒç”¨(useLayoutEffectåŒç†ï¼Œåªæ˜¯æ—¶æœºä¸åŒ)ã€‚å®ƒä¼šæ¥å—ç¬¬äºŒä¸ªå‚æ•°ï¼Œåªå…³æ³¨æŸäº›çŠ¶æ€å˜åŒ–æ‰è°ƒç”¨ã€‚åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥ç©ºæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯åªå…³æ³¨ç¬¬ä¸€æ¬¡ï¼š

```js
useEffect(() => {
  document.title = `You clicked ${count} times`;
}, []); //æ­¤æ—¶åªä¼šåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“åè°ƒç”¨ã€‚
```

è¿™æ ·çš„å®ç°åŸºæœ¬æ»¡è¶³æˆ‘ä»¬åªæ‰§è¡Œä¸€æ¬¡çš„è¦æ±‚ï¼Œä½†æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œæ‰§è¡Œçš„æ—¶æœºæ˜¯åœ¨æ¸²æŸ“åï¼Œæˆ‘ä»¬æœ‰æ—¶å€™ä¼šæƒ³åœ¨æ¸²æŸ“å‰ä½œå‡†å¤‡ã€‚è¦é€‚åº”è¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ useState æ¥æ¨¡æ‹Ÿï¼Œè®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½æ¥æ¥è¡¨ç¤ºæ˜¯ä¸æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œã€‚å¯ä»¥å†™ä¸€ä¸ªè‡ªå®šä¹‰ hook å·¥å…·æ–¹æ³•ï¼š

```js
const useConstructor(callBack = () => {}) => {
  const [hasBeenCalled, setHasBeenCalled] = useState(false);
  if (hasBeenCalled) return;
  callBack();
  setHasBeenCalled(true);
}
```

è¿™æ ·ï¼Œæˆ‘ä»¬åœ¨å‡½æ•°ç»„ä»¶ç¬¬ä¸€è¡Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼ŒåŒ…ä½åˆå§‹åŒ–é€»è¾‘å°±èƒ½æ»¡è¶³åœ¨æ¸²æŸ“å‰è°ƒç”¨:

```js
function Example() {
  useConstructor(()=>{
    // åˆå§‹åŒ–é€»è¾‘
  });
  const [count, setCount] = useState(0);

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>
       Click me
      </button>
    </div>
  );
}
```

è¿™æ ·æ˜¯ä¸æ˜¯å®Œç¾æ¨¡æ‹Ÿäº†å‘¢ï¼Ÿå…¶å®è¿˜æ˜¯æœ‰ä¸¤ä¸ªå°ç¼ºç‚¹ï¼š

1. è°ƒç”¨ setHasBeenCalled ä¼šè§¦å‘ä¸€æ¬¡ä¸å¿…è¦çš„åˆ·æ–°ï¼›
2. useConstructor å‘½åä¸åˆé€‚ï¼Œå› ä¸ºä¸æ˜¯çœŸçš„æ„é€ å‡½æ•°ï¼Œå®é™…è°ƒç”¨ç‚¹æ˜¯é ä½¿ç”¨æ–¹åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨ï¼›
åŸºäºè¿™ä¸¤ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ä¼˜åŒ–ä¸€ä¸‹æˆè¿™æ ·ï¼š

```js
const useSingleton = (callBack = () => {}) => {
  const hasBeenCalled = useRef(false);
  if (hasBeenCalled.current) return;
  callBack();
  hasBeenCalled.current = true;
}
```

è¿™ä¸ªå‡½æ•°å®é™…æ˜¯ä¸€ä¸ªå•ä¾‹å‡½æ•°ï¼Œç¡®ä¿ä¼ å…¥çš„å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡ã€‚useRef å¯ä»¥ç†è§£ä¸ºå‡½æ•°ç»„ä»¶çš„å…¨å±€å˜é‡ï¼Œå¯¹å®ƒä¿®æ”¹ä¸ä¼šè§¦å‘åˆ·æ–°ã€‚
è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦è¯´ä¸€ä¸‹ï¼ŒuseSingleton æ˜¯å¯ä»¥åœ¨åŒä¸€ä¸ªå‡½æ•°ç»„ä»¶é‡Œå¤šæ¬¡ä½¿ç”¨ï¼ŒuseRef ä¼šæ¯æ¬¡éƒ½ç”Ÿæˆæ–°çš„å˜é‡ï¼ŒReact ä¼šä¿è¯ä¸ä¼šç›¸äº’å¹²æ‰°å¹¶æ­£ç¡®æ‰§è¡Œã€‚

è¿™ä¸ªæ¨¡æ‹Ÿæ„é€ å‡½æ•°è¿˜èƒ½ä¸èƒ½è¿›ä¸€æ­¥ä¼˜åŒ–å‘¢ï¼Œæ¯”å¦‚æœŸæœ› useSingleton æœ‰è¿”å›å€¼ï¼Œä¸€æ¬¡æ‰§è¡Œï¼Œæ¯æ¬¡éƒ½è·å–ç›¸åŒçš„ç»“æœï¼Ÿ
å¯ä»¥çš„ã€‚æ ¹æ® Reactjs å®˜æ–¹æ–‡æ¡£çš„[æƒ°æ€§åˆå§‹State](https://zh-hans.reactjs.org/docs/hooks-reference.html#lazy-initial-state)ï¼Œ å¯ä»¥ç»™ useState ä¼ å‡½æ•°ï¼Œå¹¶ä¸”åªä¼šåœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶è°ƒç”¨ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ– useSingletonï¼Œå†åŠ ä¸Šè€ƒè™‘è¿”å›å€¼çš„è¯ï¼Œæœ€ç»ˆç‰ˆæ˜¯è¿™æ ·ï¼š

```js
export function useSingleton<T>(callBack: () => T): T {
    const [T] = useState(callBack);
    return T
}
```

ç„¶åè¿™æ ·ä½¿ç”¨ï¼š

```js
function Example() {
  const store:IStore = useSingleton(()=>{
    return new FileStore();
  });

  const [count, setCount] = useState(store.get('click_count'));

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>
       Click me
      </button>
    </div>
  );
}
```

å¥½äº†ï¼Œä»¥ä¸Šå°±æ˜¯æœ€ç»ˆç‰ˆæœ¬äº†ï¼Œå®ŒğŸ˜Š

å‚è€ƒï¼šhttps://dev.to/bytebodger/constructors-in-functional-components-with-hooks-280m